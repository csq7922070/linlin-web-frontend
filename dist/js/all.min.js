var basePath="http://mifan.4zlink.com:8080/mifan",skhControllers=angular.module("skhControllers",["ui.router"]),myApp=angular.module("myApp",["ui.router","angular-carousel","skhControllers"]);myApp.config(["$stateProvider","$urlRouterProvider",function(e,t){t.otherwise("/home"),e.state("notice",{url:"/notice/list",templateUrl:"tpl/notice/notice.list.htm",controller:"noticeListCtrl"}).state("notice-detail",{url:"/notice/:id",templateUrl:"tpl/notice/notice.detail.htm",controller:"noticeDetailCtrl"}).state("repair",{url:"/repair-list",templateUrl:"tpl/repair/repair.list.htm",controller:"repairListCtrl"}).state("repair-detail",{url:"/repair/:id",templateUrl:"tpl/repair/repair.detail.htm",controller:"repairDetailCtrl"}).state("repair-add",{url:"/repair-add",templateUrl:"tpl/repair/repair.add.htm",controller:"repairAddCtrl"}).state("complain",{url:"/complain-list",templateUrl:"tpl/complain/complain.list.htm",controller:"complainListCtrl"}).state("complain-detail",{url:"/complain/:id",templateUrl:"tpl/complain/complain.detail.htm",controller:"complainDetailCtrl"}).state("complain-add",{url:"/complain-add",templateUrl:"tpl/complain/complain.add.htm",controller:"complainAddCtrl"}).state("address",{url:"/address",templateUrl:"tpl/service/address.html"}).state("address-floor",{url:"/address-floor/",templateUrl:"tpl/service/address-floor.html",controller:"addressFloorCtrl"}).state("address-unit",{url:"/address-unit/:floor",templateUrl:"tpl/service/address-unit.html",controller:"addressUnitCtrl"}).state("address-room",{url:"/address-room/:floor/:unit",templateUrl:"tpl/service/address-room.html",controller:"addressRoomCtrl"}).state("address-final",{url:"/address-final/:id/:floor/:unit/:room/:username/:initial",templateUrl:"tpl/service/address.html",controller:"addressCtrl"}).state("account",{url:"/account/:floor/:unit/:room/:id/:username",templateUrl:"tpl/service/account.html",controller:"accountCtrl"}).state("payment",{url:"/payment",templateUrl:"tpl/service/payment.html",controller:"paymentCtrl"}).state("home",{url:"/home",templateUrl:"tpl/index/home.html",controller:"homeCtrl"}).state("home.shop-info",{url:"/shop-info/:site",templateUrl:"tpl/index/shop-info.html",controller:"shopInfoCtrl"}).state("owner-address",{url:"/owner-address",templateUrl:"tpl/service/owner-address.html",controller:"ownerCtrl"}).state("account-record",{url:"/account-record/:id",templateUrl:"tpl/service/account-record.html",controller:"accountRecordCtrl"}).state("html-error",{url:"/html-error",templateUrl:"tpl/index/html-error.html"})}]).config(["$httpProvider",function(e){e.defaults.headers.put["Content-Type"]="application/x-www-form-urlencoded",e.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded",e.defaults.transformRequest=[function(e){var t=function(e){var o,r,n,s,a,l,i,c="";for(o in e)if(r=e[o],r instanceof Array)for(i=0;i<r.length;++i)a=r[i],n=o+"["+i+"]",l={},l[n]=a,c+=t(l)+"&";else if(r instanceof Object)for(s in r)a=r[s],n=o+"["+s+"]",l={},l[n]=a,c+=t(l)+"&";else void 0!==r&&null!==r&&(c+=encodeURIComponent(o)+"="+encodeURIComponent(r)+"&");return c.length?c.substr(0,c.length-1):c};return angular.isObject(e)&&"[object File]"!==String(e)?t(e):e}]}]).run(["$rootScope",function(e){e.$on("$stateChangeSuccess",function(t,o,r,n,s){e.previousState=n.name,e.currentState=o.name,_hmt.push(["_trackPageview",o.name])})}]),skhControllers.controller("accountCtrl",["$scope","$http","$stateParams","$rootScope","$state",function(e,t,o,r,n){e.ownerName=o.username,e.floor=o.floor,e.unit=o.unit,e.room=o.room,e.id=o.id,console.log(o.id),t({method:"GET",url:basePath+"/payment/getAmount.do",params:{paymentState:0,id:o.id}}).success(function(t){if(""!=t){e.freeShow=!1;var o=t.amountList,n={};n.datas=new Array;for(var s=0;s<o.length;s++){var a=o[s].year+"年"+o[s].month+"月",l={};if(l.id=o[s].id,l.type=o[s].paymentType,l.amount=o[s].amount,n.datas.length>0){for(var i=0;i<n.datas.length;i++)if(n.datas[i].yearmonth==a){n.datas[i].eles.push(l);break}if(i==n.datas.length){var t={};t.yearmonth=a,t.eles=new Array,t.eles.push(l),n.datas.push(t)}}else{var t={};t.yearmonth=a,t.eles=new Array,t.eles.push(l),n.datas.push(t)}}e.payments=n.datas,e.selectAll=function(){},e.selected=[],e.total=0,e.update=function(t){if(t.selected)-1==e.selected.indexOf(t.id)&&(e.selected.push(t.id),e.total+=t.amount);else if(-1!=e.selected.indexOf(t.id)){var n=e.selected.indexOf(t.id);e.selected.splice(n,1),e.total-=t.amount}for(var s=0,a=0,l=[],i=[],c=e.selected,u=o,d=0;d<u.length;d++)for(var m=0;m<c.length;m++)u[d].id==c[m]&&(0==u[d].paymentType?(s+=u[d].amount,l.push(u[d].month)):(a+=u[d].amount,i.push(u[d].month)));r.waterFree=s,r.eleFree=a,r.wmonth=l,r.emonth=i},e.updateYearmonth=function(t,n){for(var s=0;s<e.payments.length;s++)if(e.payments[s].yearmonth==t){for(var a=0;a<e.payments[s].eles.length;a++){var l=e.payments[s].eles[a];if(n)-1==e.selected.indexOf(l.id)&&(e.selected.push(l.id),e.total+=l.amount,l.selected=!0);else if(-1!=e.selected.indexOf(l.id)){var i=e.selected.indexOf(l.id);e.selected.splice(i,1),e.total-=l.amount,l.selected=!1}}break}for(var c=0,u=0,d=e.selected,m=[],p=[],h=o,s=0;s<h.length;s++)for(var a=0;a<d.length;a++)h[s].id==d[a]&&(0==h[s].paymentType?(c+=h[s].amount,m.push(h[s].month)):(u+=h[s].amount,p.push(h[s].month)));r.waterFree=c,r.eleFree=u,r.wmonth=m,r.emonth=p},e.updateAll=function(t){angular.forEach(e.payments,function(o){o.selected=t,angular.forEach(o.eles,function(o){if(t)-1==e.selected.indexOf(o.id)&&(e.selected.push(o.id),e.total+=o.amount,o.selected=!0);else if(-1!=e.selected.indexOf(o.id)){var r=e.selected.indexOf(o.id);e.selected.splice(r,1),e.total-=o.amount,o.selected=!1}})});for(var n=0,s=0,a=e.selected,l=[],i=[],c=o,u=0;u<c.length;u++)for(var d=0;d<a.length;d++)c[u].id==a[d]&&(0==c[u].paymentType?(n+=c[u].amount,l.push(c[u].month)):(s+=c[u].amount,i.push(c[u].month)));r.waterFree=n,r.eleFree=s,r.wmonth=l,r.emonth=i}}}).error(function(e){console.log("数据")})}]),skhControllers.controller("accountRecordCtrl",["$scope","$http","$stateParams","$rootScope","$state",function(e,t,o,r,n){e.records={amountList:[{id:4,year:"2015",month:12,amount:35.99,paymentType:"1",number:"3456°-1246°",count:"-2210°"},{id:5,year:"2015",month:11,amount:4.11,paymentType:"0",number:"0m³-3456m³",count:"3456m³"}],amountSum:"444.00"}}]),skhControllers.controller("addressCtrl",["$scope","$http","$stateParams","$rootScope",function(e,t,o,r){e.add_newaddress=function(){t({method:"POST",url:basePath+"/archives/addHouse",data:{court:"阿尔卡迪亚",floor:o.floor,unit:o.unit,roomNo:o.room,openid:sessionStorage.getItem("openid"),id:o.id,initial:o.initial}}).success(function(e){console.log("后台添加地址成功")}).error(function(e){console.log("后台添加地址成功")})},console.log("floor"+o.floor+" unit"+o.unit+" room"+o.room),console.log("succees"),e.floor=o.floor,e.unit=o.unit,e.room=o.room,e.username=o.username,e.id=o.id,console.log("username:"+e.username+" id:"+e.id),console.log(o.initial)}]),skhControllers.controller("addressFloorCtrl",["$scope","$http","$stateParams","$rootScope",function(e,t,o,r){t({method:"GET",url:basePath+"/archives/getFloor.do"}).success(function(t){e.datas=t})}]),skhControllers.controller("addressRoomCtrl",["$scope","$http","$stateParams","$rootScope","$state",function(e,t,o,r,n){t({method:"GET",url:basePath+"/archives/getRoom.do",params:{floor:o.floor,unit:o.unit}}).success(function(t){e.floor=o.floor,e.unit=o.unit,e.rooms=t.items})}]),skhControllers.controller("addressUnitCtrl",["$scope","$http","$stateParams","$rootScope","$state",function(e,t,o,r,n){t({method:"GET",url:basePath+"/archives/getUnit.do",params:{floor:o.floor}}).success(function(t){e.units=t.items,e.floor=o.floor})}]),skhControllers.controller("complainAddCtrl",["$scope","$http","$timeout","$state",function(e,t,o,r){e.suc_show=!1,e.err_show=!1,e.mask_close=function(){e.suc_show=!1},e.mask_err_close=function(){e.err_show=!1},e.submitForm=function(){t({method:"POST",url:basePath+"/complain/add.do",data:{title:e.title,mobile:e.mobile,content:e.content,openid:sessionStorage.getItem("openid")}}).success(function(t){e.suc_show=!0,o(function(){e.suc_show=!1,r.go("complain")},3e3)}).error(function(t){e.err_show=!0,o(function(){e.err_show=!1},3e3)})}}]),skhControllers.controller("complainDetailCtrl",["$scope","$http","$stateParams",function(e,t,o){t({method:"GET",url:basePath+"/complain/get.do",params:{id:o.id}}).success(function(t){e.complain=t})}]),skhControllers.controller("complainListCtrl",["$scope","$http",function(e,t){e.currentPage=0,e.pageSize=10,e.load=function(o,r){o>e.numberOfPages||e.currentPage==o||1>o||e.busy||(e.busy=!0,t({method:"GET",url:basePath+"/complain/getByOpenid",params:{offset:e.pageSize*(o-1),limit:e.pageSize,openid:sessionStorage.getItem("openid")}}).success(function(t){e.numberOfPages=Math.ceil(t.count/e.pageSize),e.currentPage=o,e.busy=!1,e.complains=t.items}))},e.load(1,e.pageSize)}]),skhControllers.controller("homeCtrl",["$scope","$http","$stateParams","$rootScope","$state","$location",function(e,t,o,r,n,s){var a=s.url().substring(s.url().indexOf("?"));-1!=a.indexOf("home")&&(a=""),null==sessionStorage.getItem("openid")&&t({method:"GET",url:basePath+"/getopenid"+a}).success(function(e){sessionStorage.setItem("openid",e.openid),console.log("获取openid成功")}).error(function(e){console.log("获取openid失败")}),e.slides7=[{id:10,label:"slide #1",img:"images/banner_01.png"},{id:11,label:"slide #2",img:"images/banner_02.png"},{id:12,label:"slide #3",img:"images/banner_03.png"}],e.carouselIndex7=0,r.site=1,n.go("home.shop-info",{site:1})}]),skhControllers.controller("noticeDetailCtrl",["$scope","$http","$stateParams",function(e,t,o){t({method:"GET",url:basePath+"/notice/get.do",params:{id:o.id}}).success(function(t){e.notice=t})}]),skhControllers.controller("noticeListCtrl",["$scope","$http",function(e,t){e.currentPage=0,e.pageSize=10,e.load=function(o,r){o>e.numberOfPages||e.currentPage==o||1>o||e.busy||(e.busy=!0,t({method:"GET",url:basePath+"/notice/list.do",params:{offset:e.pageSize*(o-1),limit:e.pageSize,openid:sessionStorage.getItem("openid")}}).success(function(t){e.numberOfPages=Math.ceil(t.count/e.pageSize),e.currentPage=o,e.busy=!1,e.notices=t.items}))},e.load(1,e.pageSize)}]),skhControllers.controller("ownerCtrl",["$scope","$http","$stateParams","$rootScope","$state",function(e,t,o,r,n){t({method:"GET",url:basePath+"/archives/findHouseByOpenid",params:{openid:sessionStorage.getItem("openid")}}).success(function(o){""!=o&&(e.houses=o.items,o.items.forEach(function(o){0==o.active&&(e.activeId=o.id),o.deleteAddress=function(r){e.sure_delete=!0,e.sure=function(){e.sure_delete=!1,t({method:"POST",url:basePath+"/archives/delHouse",data:{id:o.id}}).success(function(t){e.houses.splice(r,1),console.log("删除成功")}).error(function(e){console.log("删除失败")})},e.cancel=function(){e.sure_delete=!1}},o.change_flag=function(){0!=o.active&&t({method:"POST",url:basePath+"/archives/updateHouseActive",data:{id:o.id,openid:sessionStorage.getItem("openid")}}).success(function(t){e.activeId=o.id,console.log("设置默认地址成功")}).error(function(e){console.log("设置默认地址失败")})}}))}).error(function(e){})}]),skhControllers.controller("paymentCtrl",["$scope","$http","$stateParams","$rootScope","$state",function(e,t,o,r,n){e.watmonth_f=r.wmonth,e.watmonth=e.watmonth_f.join(","),e.elmonth_f=r.emonth,e.elmonth=e.elmonth_f.join(","),e.floor=r.floor,e.unit=r.unit,e.room=r.room,e.waterFr=r.waterFree,e.eleFr=r.eleFree,e.totalFee=r.waterFree+r.eleFree,e.money_payment=function(){console.log("支付功能开始"),t({method:"GET",url:basePath+"/payment/webchatPay",params:{total_fee:e.totalFee,openid:sessionStorage.getItem("openid")}}).error(function(e,t,o,r){self.error="连接错误!"}).then(function(e){return"FAIL"==e.data.return_code?(self.error=e.data.return_msg,$q.reject()):$q.resolve({appid:e.data.appid,prepay_id:e.data.prepay_id,timestamp:e.data.timestamp,nonceStr:e.data.nonceStr,paySign:e.data.sign,timestamp:e.data.timestamp})}).then(function(e){var t=$q.defer();return wx.config({debug:!0,appId:e.appid,timestamp:sessionStorage.getItem("timestamp"),nonceStr:sessionStorage.getItem("noncestr"),signature:sessionStorage.getItem("sign"),jsApiList:["chooseWXPay"]}),wx.chooseWXPay({timestamp:e.timestamp,nonceStr:e.nonceStr,"package":e.prepay_id,signType:"MD5",paySign:e.paySign,success:function(e){console.log("successfully paid",e),t.resolve("success")}}),t.promise}).then(function(){return n.go("success"),$q.resolve(!0)})}}]),skhControllers.controller("repairAddCtrl",["$scope","$http","$timeout","$state",function(e,t,o,r){e.mask_close=function(){e.suc_show=!1},e.mask_err_close=function(){e.err_show=!1},e.submitForm=function(){t({method:"POST",url:basePath+"/repair/add.do",data:{device:e.device,remark:e.remark,mobile:e.mobile,unit:e.unit,roomNo:e.roomNo,floor:e.floor,openid:sessionStorage.getItem("openid")}}).success(function(t){e.suc_show=!0,o(function(){e.suc_show=!1,r.go("repair")},3e3)}).error(function(t){e.err_show=!0,o(function(){e.err_show=!1},3e3)})}}]),skhControllers.controller("repairDetailCtrl",["$scope","$http","$stateParams","$timeout",function(e,t,o,r){e.suc_show=!1,e.err_show=!1,t({method:"GET",url:basePath+"/repair/get.do",params:{id:o.id}}).success(function(o){e.repair=o,e.repair.confirm=function(){t({method:"POST",url:basePath+"/repair/finish.do",data:{id:e.repair.id}}).success(function(t){e.suc_show=!0,r(function(){e.suc_show=!1,e.success=!0},3e3)}).error(function(t){e.err_show=!0,r(function(){e.err_show=!1},3e3)})}})}]),skhControllers.controller("repairListCtrl",["$scope","$http","$timeout","$state",function(e,t,o,r){e.currentPage=0,e.pageSize=10,e.suc_show=!1,e.err_show=!1,e.repairs=[],e.load=function(n,s){n>e.numberOfPages||e.currentPage==n||1>n||e.busy||(e.busy=!0,t({method:"GET",url:basePath+"/repair/list.do",params:{offset:e.pageSize*(n-1),limit:e.pageSize,openid:sessionStorage.getItem("openid")}}).success(function(s){e.numberOfPages=Math.ceil(s.count/e.pageSize),e.currentPage=n,e.busy=!1,s.items.forEach(function(n){e.repairs.push(n),n.confirm=function(){t({method:"POST",url:basePath+"/repair/finish.do",data:{id:n.id}}).success(function(t){e.suc_show=!0,o(function(){e.suc_show=!1,r.go("repair",{},{reload:!0})},3e3)}).error(function(t){e.err_show=!0,o(function(){e.err_show=!1},3e3)})}})}))},e.load(1,e.pageSize)}]),skhControllers.controller("shopInfoCtrl",["$scope","$http","$stateParams","$rootScope","$state",function(e,t,o,r,n){r.site=o.site,e.currentPage=0,e.pageSize=5,e.shops=[],e.load=function(n,s){n>e.numberOfPages||e.currentPage==n||1>n||e.busy||3!=r.site&&(e.busy=!0,t({method:"GET",url:basePath+"/getBusiness.do",params:{offset:e.pageSize*(n-1),limit:8==s?s:e.pageSize,type:o.site-1}}).success(function(t){e.numberOfPages=Math.ceil(t.count/e.pageSize),e.currentPage=n,e.busy=!1,e.shops.push.apply(e.shops,t.items)}).error(function(e){}))},e.load(1,8)}]),myApp.directive("errSrc",function(){return{link:function(e,t,o){t.bind("error",function(){o.src!=o.errSrc&&o.$set("src",o.errSrc)})}}}),myApp.directive("whenScrolled",["$document",function(e){return{restrict:"A",link:function(t,o,r){var n=o[0];e.bind("scroll",function(){var e=n.getBoundingClientRect();window.innerHeight>=e.bottom&&t.$apply(r.whenScrolled)})}}}]),skhControllers.service(function(){console.log("sample service")}),skhControllers.filter("cut",function(){return function(e,t,o,r){if(!e)return"";if(o=parseInt(o,10),!o)return e;if(e.length<=o)return e;if(e=e.substr(0,o),t){var n=e.lastIndexOf(" ");-1!=n&&(e=e.substr(0,n))}return e+(r||"...")}});